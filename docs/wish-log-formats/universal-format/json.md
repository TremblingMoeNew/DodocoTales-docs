# 通用祈愿格式 - Json格式 

!> 本章节按照`v1.0`版本以上的嘟嘟可故事集对通用祈愿格式的实现与自行扩展进行介绍，以下内容并不等价于UIGF.J标准。

通用祈愿Json格式的设计侧重于更好的兼容与反应米哈游官方的祈愿记录API所返回的原始数据、以及更高效更便捷的导入导出处理。

其根对象下包含`info`与`list`两个字段，前者为一个保持该记录文件基本信息的对象，后者用于存放所有祈愿记录项的一个数组。

文件格式大致如下：

```json
{
    "info" : {
        "uid" : "000000000",
        "lang" : "zh-cn",
        ...
    },
    "list" : [
        {
            "gacha_type": "000",
            "time": "yyyy-MM-dd HH:mm:ss",
            "name": "以理服人",
            "item_type": "武器",
            "rank_type": "3",
            "id": "1600099200004770203",
            "uigf_gacha_type": "000",
        },
        ...
    ]
}
```

## 文件基本信息

`info`用于储存该通用祈愿记录文件所具有的一些基本信息，包括该记录的用户信息、导出信息、以及其他的扩展信息。

### 用户信息

祈愿记录工具需要通过用户的`uid`以确定该记录的归属，而`lang`则标记了祈愿记录项的语言。

鉴于单个通用祈愿记录文件仅会包含一名用户的祈愿记录，而标准规定文件内所有记录项应当为同一语言，这两项可以被分类为“用户信息”，并从记录项中提取出来、置于文件基本信息部分。

根据标准规定，为兼顾数据交换的信息完整性与用户保护隐私、信息脱敏的可能需要，`uid`与`lang`为**建议保留的可选字段**。

| 字段   | UIGF规定                                        | 嘟嘟可故事集 - 导入                                        | 嘟嘟可故事集 - 导出                                          |
| ------ | ----------------------------------------------- | ---------------------------------------------------------- | ------------------------------------------------------------ |
| `uid`  | 建议保留。                                      | 当前必要，未来将可能允许导入时手动设置或作为临时记录读取。 | 当前保留，未来将允许去除。                                   |
| `lang` | 建议保留。必须为`zh-cn`。祈愿记录项必须为中文。 | 不必要。支持简体中文与英文记录·。                          | 保留。目前仅支持简中导出(`zh-cn`)，未来将支持英文(`en-us`)。 |

### 导出信息

祈愿记录工具需要在通用祈愿记录文件中记录一些额外的信息，标识该文件遵循的标准版本、导出程序以及导出时间信息，以便其他工具能够对该记录文件进行正确处理。

标准并未强制要求以下字段需要被实现，但部分工具可能对其具有强制依赖。

| 字段          | 含义                              | UIGF规定                                | 嘟嘟可故事集 - 导入 | 嘟嘟可故事集 - 导出         |
| ------------- | ----------------------------------------- | ------------------- | --------------------------- | --------------------------- |
| `export_time` | 文件生成时间 | 未强制要求，格式应为`yyyy-MM-dd hh:mm:ss` | 非必要              | 格式为`yyyy-MM-dd hh:mm:ss` |
| `export_app`  | 文件创建工具标识      | 未强制要求。由各工具自行定义。 | 非必要              | `DodocoTales`               |
|`export_app_version`|工具版本标识|未强制要求。由各工具自行定义。|非必要|主程序版本号|
|`uigf_versuon`|遵循的UIGF版本号|[已定义的](wish-log-formats/universal-format/uigf.md#uigf_version)UIGF版本号。|暂无限制|`v2.1`|
|`export_timestamp`|文件生成的UNIX时间戳|于`v2.2`加入标准。|不支持，将被忽略|不支持|

### 扩展信息

!> 以下字段并非UIGF标准的一部分。

扩展信息为一系列由嘟嘟可故事集或其他祈愿工具所自定义的字段，其并非标准的一部分。

嘟嘟可故事集所引入的扩展字段均具有`__ddc_`前缀。

| 字段 | 含义 | 取值 | 支持的祈愿工具 |
| ---- | ---- | ---- | ---- |
| `__ddc_client_region` | 游戏客户端类型 |`cn`(国服客户端) / `overseas`(国际服客户端)|嘟嘟可故事集|
| `__ddc_timezone` | 用户所在服务器的祈愿记录时区 |`UTC+8`(亚太地区各服务器) / `UTC+1`(欧服) /  `UTC-5`(美服)|嘟嘟可故事集|

## 祈愿记录项

`list`数组用于存放用户的祈愿记录项。祈愿记录项中应当包含足够的必要信息，且需尽可能反应从米哈游官方的祈愿记录API所获取到的原始记录的样貌。

### 必要原始信息

标准规定了一些必要的字段。各祈愿工具应当保证记录中具有有效的以下字段。

| 字段 |  嘟嘟可故事集 - 导入 | 嘟嘟可故事集 - 导出 |
| ---- | ---- | -------- |
| `id` | 非必要 | 全部包含 |
|`name`|必要，支持简体中文或英文的完整名称|全部包含，支持简体中文|
|`gacha_type`|必要|全部包含|
|`item_type`|非必要|全部包含|

#### `id`

标识祈愿记录项的唯一编号。

由于官方祈愿API在游戏1.3版本前并不返回`id`值，以及部分祈愿导出工具可能不保存或曾经不保存祈愿记录的`id`值，该项可能丢失。

标准规定，`0-1612303200000000000`间的`id`值视为补全生成值。各工具在导出时应当使用该区间内的值为缺失`id`项的祈愿记录进行填充与补全，在导入时应当对补全生成值范围内的`id`进行特殊处理以避免其引起不必要的冲突与困扰。

同时，虽然标准规定`id`值是必要的，但其同时也要求各祈愿工具具有处理`id`值完全缺失的状况的能力。

嘟嘟可故事集允许导入的通用祈愿格式文件中祈愿项`id`的缺失，但不能保证该类项在导入时的完全正确性。

嘟嘟可故事集在导出时将为`id`项缺失的祈愿项生成`1000000000000000000`起的补全生成值，导入时将`0-1599999999999999999`间的`id`值视为无效`id`，不支持负值。

#### `name`

该次祈愿获得的单位名称。应为单位的官方完整名称。标准仅支持简体中文名称。

嘟嘟可故事集导入时支持简体中文或英文名称，导出时暂仅支持简体中文名称。

由于嘟嘟可故事集采用内部的单位数据库记录单位信息，`name`项与记录的单位名称全部无法匹配的祈愿记录项无法被导入。

#### `gacha_type`

该次祈愿的祈愿类型。应为官方API所使用的三位数字代号。

| `gacha_type` | 官方名称 |
| ------------ | -------- |
| `100`        | 新手祈愿 |
|`200`|常驻祈愿|
|`301`|角色活动祈愿|
|`400`|角色活动祈愿-2|
|`302`|武器活动祈愿|

#### `item_type`

该次祈愿获得的单位类型，即该单位属于角色或属于武器。

根据UIGF标准最大程度保持记录项原貌的理念、以及米哈游官方API所返回的祈愿项值，参考取值分别应当为`角色`与`武器`。

嘟嘟可故事集采用`name`在其单位数据库中进行匹配，导入时并不使用`item_type`项。

### 必要注入信息

标准尽可能追求保持祈愿项的原貌，但依然规定了一些必要的注入项信息。这些注入字段均具有`uigf_`前缀。

| 字段              | 含义 | 嘟嘟可故事集 - 导入 | 嘟嘟可故事集 - 导出 |
| ----------------- | ---- | -------- | ------------------- |
| `uigf_gacha_type` | 共享祈愿记录统计的祈愿类型 | 必要，取值为`100`/`200`/`301`/`302` | 包含，取值为`100`/`200`/`301`/`302` |

#### `uigf_gacha_type`

2.3版本后的游戏引入了“角色活动祈愿-2”(`400`)这一新的祈愿类型。

其与“角色活动祈愿”(`301`)共享抽数统计，在官方的祈愿记录页与API中也被合并作为“角色活动祈愿与角色活动祈愿-2”(`301`)进行展示。

为方便各祈愿工具的处理、以及保证未来可能的继续加入类似祈愿类型时的识别扩展性，标准引入了注入字段`uigf_gacha_type`。

| `uigf_gacha_type` | 对应`gacha_type` | 官方名称 |
| ----------------- | ---------------- | -------- |
| `100`             | `100` | 新手祈愿 |
|`200`|`200`|常驻祈愿|
|`301`|`301`/`400`|角色活动祈愿与角色活动祈愿-2|
|`302`|`302`|武器活动祈愿|

### 可选原始信息

原始祈愿记录项中包含一些其他的可选信息。

嘟嘟可故事集要求必须包含以下字段：

| 字段   | 含义 | 嘟嘟可故事集 - 导入 | 嘟嘟可故事集 - 导出 |
| ------ | --- |------------ | ------------ |
| `time` | 祈愿项原始时间，不进行时区本地转换。 |必要。格式应为`yyyy-MM-dd hh:mm:ss` |包含，格式为`yyyy-MM-dd hh:mm:ss`|

嘟嘟可故事集选用以下可选字段：

| 字段        | 含义 | 嘟嘟可故事集 - 导入 | 嘟嘟可故事集 - 导出 |
| ----------- | ------------------- | ------------------- | ------------------- |
| `rank_type` | 单位星级 | 非必要。不使用该值，使用单位数据库中记录的星级值。 |包含，取值为`3`/`4`/`5`|

其他的可选字段、以及部分标准中规定不需要的原始字段如下：

| 字段    | 含义       |
| ------- | ---------- |
| `count` | 无实际作用 |
| `item_id` | 无实际作用 |
| `uid` | **非标准字段**。用户UID。标准要求于`info`中而非祈愿记录项中记录。 |
| `lang` | **非标准字段**。祈愿项语言。标准要求于`info`中而非祈愿记录项中记录。 |