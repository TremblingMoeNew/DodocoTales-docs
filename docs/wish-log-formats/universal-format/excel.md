# 通用祈愿格式 - 工作簿格式

!> 嘟嘟可故事集未适配该格式

通用祈愿工作簿格式的设计侧重于取得面向用户的记录可视化展示与面向工具的导入方式间的平衡。

其在取得与旧有的传统祈愿导出格式尽可能的兼容及相同的可视化展示能力的同时，提供对祈愿管理工具友好的、能保留更多信息且保证统一性的数据导入手段。

因而，其可以被分为两个部分 —— 传统祈愿格式兼容部分，以及原始数据表部分。

此外，标准也允许在通用祈愿格式工作簿文件中添加如“统计分析”等其他自定义表，用于进行更好的可视化展示。

## 传统祈愿格式兼容部分

!> 支持通用祈愿格式的工具在导入时不应以该部分的数据为准。

该部分用于实现对传统祈愿导出格式的尽可能的兼容。

其主要供用户进行祈愿记录的查阅，并对于部分不支持通用祈愿格式、但支持传统祈愿导出格式的工具进行一定的向前兼容。

### 表名

其应当包含“新手祈愿”、“常驻祈愿”、“角色活动祈愿”、“武器活动祈愿”四大祈愿类型的祈愿表。

表的顺序并不强制，各个工具的实现不尽相同，且允许不包含其中的某些表。但建议您遵循下表的顺序。

**祈愿表表名应与记录项语言保持统一，以保证祈愿记录工具在导入时能对采用不支持语言的通用祈愿记录文件进行主动拒绝。**

| 表名（简体中文时） | 对应官方名称（简体中文时）   | 对应`gacha_type` | 对应`uigf_gacha_type` |
| ------------------ | ---------------------------- | ---------------- | --------------------- |
| 角色活动祈愿       | 角色活动祈愿与角色活动祈愿-2 | `301` / `400`    | `301`                 |
|武器活动祈愿|武器活动祈愿|`302`|`302`|
|常驻祈愿|常驻祈愿|`200`|`200`|
|新手祈愿|新手祈愿|`100`|`100`|

### 祈愿表结构

祈愿表中，除表头外的每一行表示一个祈愿记录项，每一列表示一个祈愿项字段。

祈愿表的行1应为表头，行2起为祈愿项。祈愿项应当**按照顺序进行排列，不限定升序或降序**。

祈愿表的**列A至列E必须为以下祈愿项字段，且必须按照下表顺序排列。**

标准未写明是否需要严格遵守以下表头命名，但建议您**在导出简体中文的祈愿项时**遵循该命名。

**表头命名应与祈愿项语言保持一致，以保证祈愿记录工具在导入时能对采用不支持语言的通用祈愿记录文件进行主动拒绝。**

列F起的列可由各工具自行定义。通常，列F为“总抽数”，列G为“距上一个五星”或“保底内”，列H则可能为祈愿项的ID。

| 列 | 表头（简体中文时） | 对应祈愿项字段 | 格式与备注 |
| -- | ------------------ | ---------- | ---- |
|A| 时间 | `time` | `yyyy-MM-dd HH:mm:ss`。祈愿项原始时间，不进行时区本地转换。 |
|B|名称|`name`|官方名称，语言与表头、表名一致。（简体中文时为中文名）|
|C|物品类型|`item_type`|官方名称，语言与表头、表名一致。（简体中文时为`角色`或`武器`）|
|D|星级|`rank_type`|数字，`3`/ `4` / `5`|
|E|祈愿类型|`gacha_type`|转义名称。详见下文。|

!> 由于列E设置为了“祈愿类型”，通用祈愿格式与传统祈愿格式及其变种间并不完全兼容。若视为传统祈愿格式文件进行导入时出现错误，可尝试通过手动删除列E（祈愿类型）解决。

#### 祈愿类型

该次祈愿的所属祈愿类型。转义规则如下表所述。

| 转义名称（简体中文时） | 对应`gacha_type` | 官方名称（简体中文时） | 所属表名（简体中文时） |
| ------------ | -------------- | -------------- | -------------- |
| 新手祈愿 | `100`        | 新手祈愿       |新手祈愿|
| 常驻祈愿 | `200`        | 常驻祈愿       |常驻祈愿|
| 角色活动祈愿 | `301`        | 角色活动祈愿   |角色活动祈愿|
| 角色活动祈愿-2 | `400`        | 角色活动祈愿-2 |角色活动祈愿|
| 武器活动祈愿 | `302`        | 武器活动祈愿   |武器活动祈愿|

## 原始数据表部分

!> 支持通用祈愿格式的工具在导入时应以该部分的数据为准。

原始数据表用于在祈愿记录工具间进行有效的、统一的数据交换。

该部分仅包含一张原始数据表。

原始数据表内的祈愿记录项应当包含足够的必要信息，且需尽可能反应从米哈游官方的祈愿记录API所获取到的原始记录的样貌 

**所有祈愿项应当保证语言的一致性。**但目前支持通用祈愿格式的工具并未全部对此进行了有效校验。

**于祈愿项为简体中文时，原始数据表的表名必须为“原始数据”。**

**原始数据表表名应与记录项语言保持统一，以保证祈愿记录工具在导入时能对采用不支持语言的通用祈愿记录文件进行主动拒绝。**

### 原始数据表结构

原始数据表中，除表头外的每一行表示一个祈愿记录项，每一列表示一个祈愿项字段。

原始数据表的行1应为表头，行2起为祈愿项。祈愿项应当**按照顺序进行排列，不限定升序或降序**。

原始数据表的**列A至列K必须为以下祈愿项字段，必须按照字段名命名，且必须按照下表顺序排列，不得减少任何一列。可选信息对应列可以为空列，但必须存在。**

| 列   | 表头 / 字段 | 类型 |
| ---- | ----------- | ---- |
| A    | `count`     | 可选原始信息 |
|B|`gacha_type`|必要原始信息|
|C|`id`|必要原始信息|
|D|`item_id`|可选原始信息|
|E|`item_type`|必要原始信息|
|F|`lang`|可选原始信息|
|G|`name`|必要原始信息|
|H|`rank_type`|可选原始信息|
|I|`time`|可选原始信息|
|J|`uid`|可选原始信息|
|K|`uigf_gacha_type`|必要注入信息|

!> 列L起的列为保留列，用于应对未来可能的添加字段的需要，不允许添加自定义的字段。

### 必要原始信息

标准规定了一些必要的字段。各祈愿工具应当保证记录中具有有效的以下字段。

| 列   | 表头 / 字段 |
| ---- | ----------- |
|B|`gacha_type`|
|C|`id`|
|E|`item_type`|
|G|`name`|

#### `id`

标识祈愿记录项的唯一编号。为一个非负数字。

由于官方祈愿API在游戏1.3版本前并不返回`id`值，以及部分祈愿导出工具可能不保存或曾经不保存祈愿记录的`id`值，该项可能丢失。

标准规定，`0-1612303200000000000`间的`id`值视为补全生成值。各工具在导出时应当使用该区间内的值为缺失`id`项的祈愿记录进行填充与补全，在导入时应当对补全生成值范围内的`id`进行特殊处理以避免其引起不必要的冲突与困扰。

同时，虽然标准规定`id`值是必要的，但其同时也要求各祈愿工具具有处理`id`值完全缺失的状况的能力。

#### `name`

该次祈愿获得的单位名称。应为单位的官方完整名称。需保证语言一致性。

#### `gacha_type`

该次祈愿的祈愿类型。应为官方API所使用的三位数字代号。

| `gacha_type` | 官方名称（简体中文时）       |
| ------------ | -------------- |
| `100`        | 新手祈愿       |
| `200`        | 常驻祈愿       |
| `301`        | 角色活动祈愿   |
| `400`        | 角色活动祈愿-2 |
| `302`        | 武器活动祈愿   |

#### `item_type`

该次祈愿获得的单位类型，即该单位属于角色或属于武器。

根据UIGF标准最大程度保持记录项原貌的理念、以及米哈游官方API所返回的祈愿项值。

需保持语言一致性。简体中文时，取值分别应当为`角色`与`武器`。

### 必要注入信息

标准尽可能追求保持祈愿项的原貌，但依然规定了一些必要的注入项信息。这些注入字段均具有`uigf_`前缀。

|列| 字段              | 含义                       |
| ----------------- | -------------------------- | ----------------------------------- |
| K| `uigf_gacha_type` | 共享祈愿记录统计的祈愿类型 |

#### `uigf_gacha_type`

2.3版本后的游戏引入了“角色活动祈愿-2”(`400`)这一新的祈愿类型。

其与“角色活动祈愿”(`301`)共享抽数统计，在官方的祈愿记录页与API中也被合并作为“角色活动祈愿与角色活动祈愿-2”(`301`)进行展示。

为方便各祈愿工具的处理、以及保证未来可能的继续加入类似祈愿类型时的识别扩展性，标准引入了注入字段`uigf_gacha_type`。

| `uigf_gacha_type` | 对应`gacha_type` | 官方名称 （简体中文时）                    |
| ----------------- | ---------------- | ---------------------------- |
| `100`             | `100`            | 新手祈愿                     |
| `200`             | `200`            | 常驻祈愿                     |
| `301`             | `301`/`400`      | 角色活动祈愿与角色活动祈愿-2 |
| `302`             | `302`            | 武器活动祈愿                 |

### 可选原始信息

原始祈愿记录项中包含一些其他的可选信息。

| 列   | 字段    | 含义与格式 |
| ---- | ------- | ---------- |
| A    | `count` | 无实际作用 |
|D|`item_id`|无实际作用|
|F|`lang`|祈愿项语言|
|H|`rank_type`|单位星级|
|I|`uid`|用户UID。|
|J|`time`|祈愿项原始时间，不进行时区本地转换。格式应为`yyyy-MM-dd hh:mm:ss`|

!> 未选用的字段，祈愿项中对应列的值应为空。无论是否选用（是否进行数据填充），所有列均必须存在。

许多祈愿工具对于`time`字段具有高度依赖，其缺失将可能造成不可预知的后果，**不建议省略**。

`lang`建议保留以进行祈愿项语言的检查以及国际化支持。

`uid`涉及用户隐私，建议默认保留、并向用户提供匿名导出的选项。